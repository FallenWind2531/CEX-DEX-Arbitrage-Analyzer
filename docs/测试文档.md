## 1. 测试环境与前置条件

### 1.1 测试环境
*   **操作系统**: Linux (WSL) / macOS / Windows
*   **Python 版本**: 3.10+
*   **依赖库**: `fastapi`, `uvicorn`, `pandas`, `numpy` (版本需与生产环境一致)
*   **硬件要求**: 内存 >= 8GB 

### 1.2 测试数据准备
在 `backend/data/` 目录下需准备以下三类数据用于测试：
1.  **Uniswap Logs**: `uniswap_logs_2025_09.json` (需包含 0x11b8 池子的 Swap 事件)。
2.  **Binance Trades**: `split_trades/*.csv` (需包含微秒级时间戳的逐笔成交数据)。
3.  **Gas Fees**: `eth_gas_fees_2025_09.csv` (区块 Gas 费)。



## 2. 测试计划

### 2.1 模块 A: 数据清洗与加载

**测试类**: `DataService`
**测试目标**: 确保原始数据被正确解析、修正和对齐。

| 用例 ID | 测试项 | 前置条件 | 操作步骤 | 预期结果 |
| :--- | :--- | :--- | :--- | :--- |
| **ETL-01** | **Uniswap 价格解码修正** | 准备一条 raw log，其 `sqrtPrice` 对应的原始价格极小 (e.g. 10^-12) | 调用 `_decode_uni_log` | 返回的 `uni_price` 应在 **2000-5000** 范围内，而不是 10^20 或 10^-12。验证倒数逻辑是否生效。 |
| **ETL-02** | **Binance 聚合逻辑** | 准备包含 1 秒内 3 笔交易的 CSV (价格: 3000, 3010, 3020; 量: 1, 1, 1) | 运行聚合逻辑 | `bin_price_close`=3020; `bin_vwap`=3010; `bin_volatility` > 0 (std计算正确)。 |
| **ETL-03** | **时间戳解析** | CSV 中包含微秒时间戳 (如 `1756684800316508`) | 加载数据 | 解析出的 `datetime` 应为 **2025年**，而不是 1970年或 +50000年。 |
| **ETL-04** | **数据对齐** | Uni 时间戳 `10:00:05`, Bin 数据在 `10:00:04` 和 `10:00:06` | 运行 `merge_asof` (direction='backward') | Uni 事件应匹配到 `10:00:04` 的 Bin 数据。 |
| **ETL-05** | **缓存机制** | 首次运行后生成 `.pkl` | 再次运行 `initialize()` | 控制台显示 "🚀 发现缓存数据"，且跳过原始文件读取，加载速度 < 1秒。 |

### 2.2 识别算法逻辑
**测试类**: `DataService.identify_opportunities_algo_b`
**测试目标**: 验证滑点模型和利润计算公式的准确性。

| 用例 ID | 测试项 | 输入参数模拟 | 预期逻辑验证 |
| :--- | :--- | :--- | :--- |
| **ALG-01** | **方向判定** | $P_{bin}=3050, P_{uni}=3000$ | `direction` 应为 `Buy_Uni_Sell_Bin`。 |
| **ALG-02** | **Uni 滑点计算** | $L=10^{20}$, $Amount=10$ | 计算结果应接近 `(10*1e18 / 10^20) * 0.5`。若 $L=0$，滑点应为惩罚值 0.1。 |
| **ALG-03** | **Bin 滑点计算** | $\sigma=5.0$, $Amount=100$, $k=0.0002$ | 滑点 `bin_slip` 应等于 $0.0002 \times 5.0 \times \sqrt{100} = 0.01 (1\%)$。 |
| **ALG-04** | **利润寻优** | 设置 3 个阶梯: 1 ETH (微利), 10 ETH (大赚), 100 ETH (滑点亏损) | 算法应返回 `optimal_amount_eth` 为 **10**，而不是 1 或 100。 |
| **ALG-05** | **固定成本过滤** | 毛利=4U, Gas=2U, Transfer=5U | `net_profit` = 4 - 2 - 5 = -3。该机会应被过滤，或返回负值。 |
| **ALG-06** | **ROI 计算** | 净利=10U, 投入=10ETH, 单价=1000U | `roi_pct` 应为 $(10 / 10000) * 100 = 0.1\%$。 |


## 3. 接口测试计划

**工具**: Postman / cURL / Swagger UI (`http://localhost:8000/docs`)

### 3.1 图表接口 (`GET /api/chart`)

*   **请求**: `GET /api/chart?timeframe=1H`
*   **检查点**:
    1.  **状态码**: 200 OK。
    2.  **数据结构**: 返回列表，包含 `timestamp`, `uni_price`, `bin_vwap`, `spread_pct`。
    3.  **数据完整性**: 检查 `uni_price` 是否有 0 或无穷大的异常值。
    4.  **业务逻辑**: 确认 `spread_pct` 计算公式为 `(bin - uni) / uni * 100`。

### 3.2 机会列表接口 (`GET /api/opportunities`)

*   **测试场景 1: 默认参数**
    *   请求: `GET /api/opportunities`
    *   预期: 返回 `net_profit_usd > 10.0` 的列表，按利润降序排列。
*   **测试场景 2: 查看亏损 (Gas 消耗分析)**
    *   请求: `GET /api/opportunities?min_profit=-50`
    *   预期: 返回包含负利润的记录。验证是否有很多 `gross_profit > 0` 但 `net_profit < 0` 的数据。
*   **测试场景 3: 数据字段校验**
    *   检查 Response Body 是否包含算法 B 特有字段: `volatility`, `optimal_amount_eth`, `roi_pct`。

### 3.3 统计摘要接口 (`GET /api/summary`)

*   **请求**: `GET /api/summary?min_profit=10`
*   **检查点**:
    1.  `total_potential_profit` 应该等于 `/api/opportunities` 中所有条目 `net_profit_usd` 的总和。
    2.  `max_single_profit` 应等于列表第一条的利润。



## 4. 异常与边界测试

| 用例 ID | 场景描述 | 预期行为 |
| :--- | :--- | :--- |
| **EDGE-01** | **数据文件缺失** | 启动时控制台打印 " 找不到文件"，程序不崩溃，API 返回空列表。 |
| **EDGE-02** | **时间戳不重叠** | Uni 数据在 9月，Bin 数据在 8月。控制台提示 "合并后没有数据"，API 返回空列表。 |
| **EDGE-03** | **Gas 文件缺失** | 控制台警告 "未找到 Gas 文件"，程序自动使用默认值 (20 Gwei) 继续运行。 |
| **EDGE-04** | **波动率为 0** | 当某时段 Binance 只有一笔交易导致 `std=NaN` 或 `0`。算法应使用默认风险值 (`eff_vol = 5.0`) 计算滑点，防止滑点为 0 导致利润虚高。 |
| **EDGE-05** | **价格剧烈波动** | 模拟 Uni 价格突然变成 0.0001。解码逻辑中的 `if final_price < 100` 过滤器应拦截该数据，防止污染图表。 |



## 5. 性能测试

*   **启动时间**:
    *   首次启动 (无缓存): 应在 5 分钟内完成。
    *   二次启动 (有缓存): 应在 5 秒 内完成。
*   **API 响应**:
    *   `/api/opportunities`: 在内存数据量为 10万行级别时，响应时间应< 200ms。


