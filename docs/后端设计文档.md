# 后端设计文档

## 1. 系统概述

本系统旨在对 **2025年9月** 期间 **Uniswap V3 (USDT/WETH 0.05%)** 与 **Binance (ETH/USDT Spot)** 的历史数据进行深度回测分析。

系统不依赖于“事后取证”（即不分析历史上别人实际发生的交易），而是采用统计学市场冲击模型。通过重建当时的市场状态（DEX 深度、CEX 波动率、Gas 费），模拟不同资金规模下的交易结果，从而识别出理论上存在的、可执行的非原子套利机会。


## 2. 系统架构
### 2.1 技术栈
*   **语言**: Python 3.10+
*   **Web 框架**: FastAPI (提供 RESTful API)
*   **数据处理**: Pandas, NumPy (向量化计算，时序对齐)
*   **存储**: 本地文件系统 (Raw JSON/CSV inputs, Pickle binary cache)

### 2.2 目录结构
```text
backend/
├── config.py           # 全局配置、路径定义、算法参数
├── data_service.py     # 核心业务逻辑：ETL、数据清洗、算法B实现
├── main.py             # API 入口、路由定义、Pydantic 模型
└── data/               # 数据存储目录
    ├── uniswap_logs_2025_09.json   # BigQuery 原始日志
    ├── split_trades/               # Binance 按日分片的 Trades CSV
    ├── eth_gas_fees_2025_09.csv    # 区块 Gas 费数据
    └── processed_algo_b_data.pkl   # [核心] 预处理后的序列化缓存
```

## 3. 数据处理流程

为了支持高精度的回测，系统会在启动时执行 ETL 流程。

### 3.1 数据输入
1.  **Uniswap V3 Logs**: 来源于 Ethereum 链上 `Swap` 事件。包含 `sqrtPriceX96` 和 `liquidity`。
2.  **Binance Trades**: 来源于交易所逐笔成交数据。包含微秒级时间戳、价格、数量。
3.  **Ethereum Gas**: 来源于区块头数据。包含 `base_fee_per_gas`。

### 3.2 数据清洗与重构
该逻辑位于 `DataService._process_raw_data` 中：

*   **Uniswap 价格重构**:
    *   将 Q64.96 格式的 `sqrtPriceX96` 转换为 `USDT per ETH`。
*   **Binance 状态聚合**:
    *   将逐笔成交数据按 **1秒 (1s)** 时间窗口重采样。
    *   计算 **VWAP** (成交量加权均价) 作为公允价格。
    *   计算 **Volatility** (成交价标准差 $\sigma$) 作为市场风险指标。
*   **Gas 对齐**:
    *   建立 `Block Number -> Base Fee` 的映射表。

### 3.3 时序对齐
*   **基准**: 以 Uniswap 的链上事件时间戳为基准。
*   **方法**: 使用 `pd.merge_asof` (方向: `backward`)。
*   **逻辑**: 对于链上的每一笔 Swap，查找其发生时刻（或之前最近时刻）的 Binance 市场状态。容忍度为 5 分钟。

### 3.4 缓存机制
*   清洗与合并后的 DataFrame 包含：`timestamp`, `uni_price`, `uni_liquidity`, `bin_vwap`, `bin_volatility`, `base_fee`。
*   数据被序列化保存为 `processed_algo_b_data.pkl`。
*   **启动优化**: 系统启动时优先加载 PKL 文件，实现秒级启动。


## 4. 识别套利机会
### 4.1 算法目标
在每一个时间切片 $t$，寻找最佳投入资金量 $V_{opt}$，使得净利润 $Profit_{net}$ 最大化。

### 4.2 核心公式

#### A. 交易方向判定
*   若 $P_{bin} > P_{uni}$ $\rightarrow$ **Buy Uni, Sell Bin** (正向搬砖)
*   若 $P_{uni} > P_{bin}$ $\rightarrow$ **Buy Bin, Sell Uni** (反向搬砖)

#### B. 滑点估算模型
对于给定的模拟交易量 $V$ (ETH)：

1.  **DEX 滑点**:
    基于当前 Tick 流动性 $L$：
    $$ S_{uni} \approx \frac{V \times 10^{18}}{L} \times 0.5 $$
    *(0.5 为经验系数，模拟集中流动性下的 tick 消耗)*

2.  **CEX 滑点**:
    由于缺乏订单簿，基于波动率 $\sigma$ 和 冲击系数 $k$：
    $$ S_{bin} = k \times \sigma \times \sqrt{V} $$
    *(参数 $k$ = `ALGO_IMPACT_FACTOR` (0.0002))*

#### C. 成本计算
1.  **Gas 成本**:
    $$ Cost_{gas} = (BaseFee + 2\text{Gwei}) \times 160,000 \times P_{uni} $$
2.  **固定磨损**:
    $$ Cost_{fix} = 5.0 \text{ USDT} $$
3.  **交易手续费**:
    $$ Cost_{fee} = V \times P \times (0.1\% + 0.05\%) $$

#### D. 寻优循环
算法会遍历配置中的 `SIMULATION_AMOUNTS` (如 [0.1, 1, 5, 10, ...])，分别计算净利润：
$$ Profit_{net}(V) = \text{GrossMargin}(V) - Cost_{gas} - Cost_{fix} $$
最终选取 $Profit_{net}$ 最大的 $V$ 作为该时刻的 **Optimal Amount**。


## 5. API 接口设计

### 5.1 获取图表数据
*   **Endpoint**: `GET /api/chart`
*   **Query Params**: `timeframe` (Default: "1H")
*   **Response**: `List[ChartPoint]`
    *   `uni_price`: DEX 价格
    *   `bin_vwap`: CEX 加权均价
    *   `spread_pct`: 价差百分比

### 5.2 获取套利机会 (核心)
*   **Endpoint**: `GET /api/opportunities`
*   **Query Params**: `min_profit` (Default: 10.0)
    *   用于过滤微利机会。
*   **Response**: `List[AlgoBOpportunity]`
    *   `optimal_amount_eth`: 算法推荐的最佳交易量。
    *   `net_profit_usd`: 扣除所有费用后的真实净利。
    *   `roi_pct`: 投资回报率。
    *   `volatility`: 当时 Binance 的波动率指标。
    *   `details`: 包含具体的滑点估算值和 Gas 成本。

### 5.3 获取统计摘要
*   **Endpoint**: `GET /api/summary`
*   **Query Params**: `min_profit`
*   **Response**: `Summary`
    *   `total_potential_profit`: 该月理论最大总盈利。
    *   `avg_roi`: 平均 ROI。


## 6. 配置参数 (Configuration)

位于 `backend/config.py`，关键参数说明：

| 参数名 | 默认值 | 说明 | 影响 |
| :--- | :--- | :--- | :--- |
| `ALGO_IMPACT_FACTOR` | 0.0002 | Binance 冲击系数 | 值越大，CEX 估算滑点越高，大额机会越少。 |
| `SIMULATION_AMOUNTS` | [0.1...100] | 模拟资金阶梯 | 决定算法寻找最优解的粒度。 |
| `FIXED_TRANSFER_COST` | 5.0 | 提币/转账费 (USDT) | 过滤小额套利机会的硬门槛。 |
| `GAS_LIMIT_SWAP` | 160000 | Swap Gas Limit | 影响链上交互成本估算。 |


## 7. 运行

1.  **环境准备**: 安装 `fastapi`, `uvicorn`, `pandas`, `numpy`。
2.  **数据准备**:
    *   放置 `uniswap_logs_2025_09.json` 到 `backend/data/`。
    *   放置拆分后的 CSV 到 `backend/data/split_trades/`。
    *   放置 `eth_gas_fees_2025_09.csv` 到 `backend/data/`。
3.  **启动**:
    ```bash
    python3 backend/main.py
    ```
4.  **首次运行**: 系统会自动进行原始数据处理（耗时约 2-5 分钟）并生成 `.pkl` 缓存。后续启动为即时响应。