
## 1. 引言

### 1.1 项目背景
在加密货币量化领域，非原子套利是一种经典的跨市场策略。本项目旨在通过回测 **2025年9月** 的历史数据，评估在 **Uniswap V3 (DEX)** 与 **Binance (CEX)** 之间进行 ETH/USDT 套利的可行性。

由于缺乏历史订单簿深度数据，本系统采用统计方法，利用波动率和成交量数据估算滑点，并结合链上 Gas 费和提币磨损，动态模拟最优交易路径。

### 1.2 产品目标
构建一个全栈分析平台，包含：
1.  **后端**: 负责清洗异构数据、重建市场状态、运行寻优算法，并提供 API。
2.  **前端**: 提供可视化仪表盘，展示价格走势、风险指标（波动率）及算法识别出的高价值套利机会。



## 2. 系统架构

### 2.1 技术栈
*   **前端**: React 18, Vite, Tailwind CSS, Recharts, Axios。
*   **后端**: Python 3.10+, FastAPI, Pandas (向量化计算), NumPy。
*   **数据存储**: 本地文件系统 (Raw JSON/CSV) + Pickle (二进制序列化缓存)。

### 2.2 数据流向
1.  **ETL**: 后端读取 BigQuery Logs (Uni) 和 CSV (Binance/Gas) $\rightarrow$ 清洗与对齐 $\rightarrow$ 生成 `.pkl` 缓存。
2.  **计算**: 用户前端调整参数 $\rightarrow$ 后端读取缓存 $\rightarrow$ 运行算法 B $\rightarrow$ 返回 JSON。
3.  **展示**: 前端接收 JSON $\rightarrow$ 渲染图表与列表。



## 3. 后端功能需求

### 3.1 数据处理

*   **REQ-B-01 多源数据解析**:
    *   系统需支持解析 JSON/JSONL 格式的 Uniswap Logs，提取 `sqrtPriceX96` 和 `liquidity`。
    *   系统需支持解析分片的 Binance Trades CSV，识别微秒级时间戳。
*   **REQ-B-02 智能价格修正**:
    *   针对 `0x11b8` 池子，系统需自动检测 Token0/Token1 顺序，通过倒置计算确保 ETH 价格落在合理区间 ($1000 - $10000)。
*   **REQ-B-03 市场状态重采样**:
    *   系统需将 CEX 逐笔成交按 **1秒** 窗口聚合。
    *   计算 **VWAP** (成交量加权均价) 作为公允价格。
    *   计算 **Standard Deviation** (标准差) 作为波动率指标 ($\sigma$)。
*   **REQ-B-04 时序对齐与缓存**:
    *   使用 `merge_asof` (Backward) 将 CEX 数据对齐到 DEX 事件时间轴。
    *   处理完毕后必须生成 `.pkl` 文件，二次启动时直接加载缓存，耗时需 < 5秒。

### 3.2 识别机会

系统需针对每一个时间切片执行以下逻辑：

*   **REQ-B-05 动态滑点估算**:
    *   **DEX 端**: 基于当前 $L$ (Liquidity) 使用模型 $S_{uni} \approx \frac{V \cdot 10^{18}}{L} \cdot 0.5$。
    *   **CEX 端**: 基于波动率 $\sigma$ 使用模型 $S_{bin} = k \cdot \sigma \cdot \sqrt{V}$ (其中 $k=0.0002$)。
*   **REQ-B-06 利润寻优循环**:
    *   系统需遍历一组预设资金量 (0.1, 1, 5, 10, ... 100 ETH)。
    *   计算公式：$Profit = (Spread - Slippage - Fees) \times Volume - Gas - TransferCost$。
    *   自动选取净利润最大的资金量作为 `optimal_amount_eth`。
*   **REQ-B-07 成本扣除**:
    *   必须扣除双边费率 (0.1% + 0.05%)。
    *   必须扣除链上 Swap Gas 费 (基于 BaseFee + Priority)。
    *   必须扣除固定提币磨损 (默认 5 USDT)。

### 3.3 API 接口层

*   **REQ-B-08 `GET /api/chart`**: 返回时间序列数据 (Uni价格, Bin VWAP, 价差%)。
*   **REQ-B-09 `GET /api/opportunities`**:
    *   接收 `min_profit` (USDT) 参数。
    *   返回包含 `optimal_amount`, `net_profit`, `roi`, `volatility` 的机会列表。
*   **REQ-B-10 `GET /api/summary`**: 返回统计摘要 (总利润, 平均 ROI)。



## 4. 前端功能需求

### 4.1 仪表盘布局

*   **REQ-F-01 全局布局**: 顶部为 Header，主体为 Dashboard，底部为 Footer。
*   **REQ-F-02 响应式设计**: 适配 Desktop (1920x1080) 和 Laptop (1366x768) 分辨率。

### 4.2 控制面板

*   **REQ-F-03 参数控制**:
    *   **时间粒度**: 下拉框 (1H, 4H, 1D)，联动图表。
    *   **最小净利润 ($)**: 数字输入框 (默认 10.0)。允许输入负数以查看 Gas 损耗情况。
   
*   **REQ-F-04 状态反馈**: 数据加载时显示 Loading Spinner，错误时显示 Toast 提示。

### 4.3 可视化图表

*   **REQ-F-05 双轴混合图**:
    *   **左轴 (线性)**: 绘制 `uni_price` (紫色线) 和 `bin_vwap` (青色线)。
    *   **右轴 (柱状/面积)**: 绘制 `spread_pct` (价差百分比)。
*   **REQ-F-06 交互联动**:
    *   鼠标悬停显示 Tooltip（包含具体价格和价差）。
    *   点击图表上的数据点，下方表格自动滚动并高亮对应的交易机会行。

### 4.4 机会列表

*   **REQ-F-07 数据展示**:
    *   **方向**: 使用彩色标签区分 "DEX -> CEX" 和 "CEX -> DEX"。
    *   **波动率**: 显示后端返回的 `volatility`。若数值过高 (如 > 10)，显示红色警告图标。
    *   **最优投入**: 显示 `optimal_amount_eth`，保留 4 位小数。
    *   **净利润**: 显示 `net_profit_usd`，**加粗高亮**。
    *   **ROI**: 显示 `roi_pct`，保留 3 位小数。
*   **REQ-F-08 详情展开**:
    *   点击表格行，展开显示成本明细：Gas 费用、DEX 预估滑点、CEX 预估滑点。
*   **REQ-F-09 排序与过滤**:
    *   默认按 **净利润** 降序排列。
    *   支持前端简单的分页或虚拟滚动 (Virtual Scroll) 以支撑 1000+ 条数据。

### 4.5 统计卡片

*   **REQ-F-10 核心指标**:
    *   **Total Opportunities**: 满足利润阈值的机会总数。
    *   **Total Potential Profit**: 所有机会净利润之和。
    *   **Avg ROI**: 平均投资回报率。


## 5. 算法参数

*   **CEX 冲击系数 ($k$)**: `0.0002` 。
*   **固定提币费**: `5.0 USDT`。
*   **Gas Limit**: `160,000`。
*   **Priority Fee**: `2 Gwei`。
*   **寻优列表**: `[0.1, 1.0, 5.0, 10.0, 20.0, 50.0, 100.0] ETH`。



## 6. 非功能需求

### 6.1 性能
*   **后端启动**: 在无缓存情况下，处理一个月数据需在 **5分钟** 内完成；有缓存时需在 **5秒** 内完成。
*   **API 延迟**: `/api/opportunities` 计算并返回结果需在 **500ms** 内 (得益于 Pandas 内存计算)。

### 6.2 健壮性
*   **数据缺失处理**: 若某时间点缺失 Binance 数据或 Gas 数据，后端必须丢弃该点，严禁返回插值估算的错误利润。
*   **异常值过滤**: 价格必须在 $1000 - $10000 之间，过滤掉解析错误的链上脏数据。